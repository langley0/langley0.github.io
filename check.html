<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paragraph-Level Translation Comparison</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #output {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
            background: #f9f9f9;
        }
        .error-paragraph {
            background-color: #ffcccc;
            padding: 5px;
            margin: 5px 0;
        }
        .valid-paragraph {
            background-color: #ccffcc;
            padding: 5px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>Paragraph-Level Translation Comparison</h1>
    <div>
        <label for="apiKey">OpenAI API Key:</label>
        <input type="password" id="apiKey" placeholder="Enter your API Key securely">
    </div>
    <div>
        <label for="originalFile">Original File:</label>
        <input type="file" id="originalFile" accept=".docx">
    </div>
    <div>
        <label for="translatedFile">Translated File:</label>
        <input type="file" id="translatedFile" accept=".docx">
    </div>
    <button id="compareBtn">Compare Files</button>
    <div id="output">
        <p>Comparison results will appear here...</p>
    </div>

    <script src="mammoth.js"></script>
    <script>
        document.getElementById('compareBtn').addEventListener('click', async function () {
            const apiKey = document.getElementById('apiKey').value;
            const originalFileInput = document.getElementById('originalFile').files[0];
            const translatedFileInput = document.getElementById('translatedFile').files[0];

            if (!apiKey) {
                alert('Please enter your OpenAI API key.');
                return;
            }

            if (!originalFileInput || !translatedFileInput) {
                alert('Please upload both the original and translated files.');
                return;
            }

            const originalText = await extractTextFromDocx(originalFileInput);
            const translatedText = await extractTextFromDocx(translatedFileInput);

            const originalParagraphs = splitIntoParagraphs(originalText);
            const translatedParagraphs = splitIntoParagraphs(translatedText);

            if (originalParagraphs.length !== translatedParagraphs.length) {
                alert('The number of paragraphs in the original and translated files do not match.');
                return;
            }

            const results = await compareParagraphs(originalParagraphs, translatedParagraphs, apiKey);
            displayComparison(results);
        });

        async function extractTextFromDocx(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const arrayBuffer = e.target.result;
                    mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                        .then(result => resolve(result.value))
                        .catch(err => reject(err));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function splitIntoParagraphs(text) {
            return text.split(/\n+/).map(para => para.trim()).filter(para => para.length > 0);
        }

        async function compareParagraphs(originalParagraphs, translatedParagraphs, apiKey) {
            const results = [];
            for (let i = 0; i < originalParagraphs.length; i++) {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4",
                        messages: [
                            { role: "system", content: "You are a helpful assistant for comparing translations." },
                            {
                                role: "user",
                                content: `Compare the following original paragraph and its translation. Indicate if the translation is correct or has issues:\n\nOriginal:\n${originalParagraphs[i]}\n\nTranslation:\n${translatedParagraphs[i]}`
                            }
                        ]
                    })
                });

                const data = await response.json();
                const feedback = data.choices[0].message.content;

                results.push({
                    original: originalParagraphs[i],
                    translated: translatedParagraphs[i],
                    feedback: feedback,
                    hasIssues: feedback.toLowerCase().includes('issue') || feedback.toLowerCase().includes('problem'),
                });
            }
            return results;
        }

        function displayComparison(results) {
            const output = document.getElementById('output');
            output.innerHTML = '';

            results.forEach((result, index) => {
                const container = document.createElement('div');
                container.className = result.hasIssues ? 'error-paragraph' : 'valid-paragraph';

                const originalPara = document.createElement('p');
                originalPara.textContent = `Original: ${result.original}`;

                const translatedPara = document.createElement('p');
                translatedPara.textContent = `Translated: ${result.translated}`;

                const feedbackPara = document.createElement('p');
                feedbackPara.textContent = `Feedback: ${result.feedback}`;

                container.appendChild(originalPara);
                container.appendChild(translatedPara);
                container.appendChild(feedbackPara);

                output.appendChild(container);
            });
        }
    </script>
</body>
</html>
